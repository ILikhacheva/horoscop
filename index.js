const path = require("path");
const express = require("express");
const bcrypt = require("bcryptjs");
require("dotenv").config({ override: true });

const app = express();
app.use(express.json());
app.use(express.static(path.join(__dirname, "public")));

const { OpenAI } = require("openai");
const {
  pool,
  testConnection,
  checkUserTableStructure,
  checkHoroscopeTableStructure,
} = require("./database");
const {
  isValidEmail,
  isValidBirthday,
  isValidZodiac,
  isValidPassword,
  ZODIAC_SIGNS,
  logSuccess,
  logError,
  logInfo,
} = require("./utils");

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã (—Ç–µ–ø–µ—Ä—å —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è, —Ç–∞–∫ –∫–∞–∫ –ø–æ–ª—É—á–∞–µ–º —Å—Ç—Ä–æ–∫–∏)
function formatDateOnly(date) {
  if (!date) return null;

  console.log("formatDateOnly –≤—Ö–æ–¥:", date, typeof date);

  // –ï—Å–ª–∏ —ç—Ç–æ —É–∂–µ —Å—Ç—Ä–æ–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
  if (typeof date === "string" && /^\d{4}-\d{2}-\d{2}$/.test(date)) {
    console.log("formatDateOnly: —Å—Ç—Ä–æ–∫–∞ YYYY-MM-DD:", date);
    return date;
  }

  // –ï—Å–ª–∏ —ç—Ç–æ –µ—â–µ Date –æ–±—ä–µ–∫—Ç (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
  if (date instanceof Date) {
    // PostgreSQL DATE –ø–æ–ª—è –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å —á–∞—Å–æ–≤—ã–º –ø–æ—è—Å–æ–º –º–æ–≥—É—Ç –±—ã—Ç—å —Å–¥–≤–∏–Ω—É—Ç—ã
    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–æ–≤–∏–Ω—É –¥–Ω—è (12 —á–∞—Å–æ–≤) —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ –¥–Ω–µ–π
    const adjustedDate = new Date(date.getTime() + 12 * 60 * 60 * 1000);

    const year = adjustedDate.getUTCFullYear();
    const month = String(adjustedDate.getUTCMonth() + 1).padStart(2, "0");
    const day = String(adjustedDate.getUTCDate()).padStart(2, "0");
    const result = `${year}-${month}-${day}`;

    console.log(
      "formatDateOnly: Date –æ–±—ä–µ–∫—Ç (fallback):",
      date.toISOString(),
      "->",
      result
    );
    return result;
  }

  console.log("formatDateOnly: unsupported format:", typeof date);
  return null;
}

// Initialize OpenAI
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});
console.log(
  "OpenAI API Key:",
  process.env.OPENAI_API_KEY
    ? process.env.OPENAI_API_KEY.substring(0, 20) + "..."
    : "No API Key Found"
);

// Testing connection to the database
testConnection();

app.get("/", (req, res) => {
  res.sendFile(path.join(__dirname, "public", "index.html"));
});

// Testing API

// Route to check existing tables
app.get("/api/check-tables", async (req, res) => {
  try {
    // Check which tables exist
    const tablesResult = await pool.query(`
      SELECT table_name 
      FROM information_schema.tables 
      WHERE table_schema = 'public' 
      ORDER BY table_name
    `);

    const tables = tablesResult.rows.map((row) => row.table_name);
    console.log("Found tables:", tables);

    // Check structure of users table
    let usersStructure = null;
    if (tables.includes("users")) {
      const usersColumns = await pool.query(`
        SELECT column_name, data_type, is_nullable 
        FROM information_schema.columns 
        WHERE table_name = 'users' AND table_schema = 'public'
        ORDER BY ordinal_position
      `);
      usersStructure = usersColumns.rows;
    }

    // Check structure of horoscops table
    let horoscopsStructure = null;
    if (tables.includes("horoscops")) {
      const horoscopsColumns = await pool.query(`
        SELECT column_name, data_type, is_nullable 
        FROM information_schema.columns 
        WHERE table_name = 'horoscops' AND table_schema = 'public'
        ORDER BY ordinal_position
      `);
      horoscopsStructure = horoscopsColumns.rows;
    }

    res.json({
      success: true,
      tables: tables,
      usersStructure: usersStructure,
      horoscopsStructure: horoscopsStructure,
    });
  } catch (error) {
    console.error("Error checking tables:", error);
    res.status(500).json({
      success: false,
      message: "‚ùå Error checking tables",
      error: error.message,
    });
  }
});

// –ú–∞—Ä—à—Ä—É—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
app.get("/api/users", async (req, res) => {
  try {
    const client = await pool.connect();
    const result = await client.query(
      "SELECT id_user, first_name, email, to_char(birthday, 'YYYY-MM-DD') AS birthday, zodiac, subscription, created_at, updated_at FROM users ORDER BY created_at DESC"
    );
    client.release();

    res.json({
      success: true,
      users: result.rows,
    });
  } catch (error) {
    console.error("Error fetching users:", error);
    res.status(500).json({
      success: false,
      message: "‚ùå Error fetching users",
      error: error.message,
    });
  }
});

// –ú–∞—Ä—à—Ä—É—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
app.post("/api/register", async (req, res) => {
  console.log("üîç –ó–∞–ø—Ä–æ—Å –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –ø–æ–ª—É—á–µ–Ω");
  console.log("üì¶ –î–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞:", req.body);
  console.log("üìã Headers:", req.headers);

  try {
    const { email, name, birthday, zodiac, password } = req.body;

    console.log("‚úÖ –†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:", {
      email,
      name,
      birthday,
      zodiac,
      password: password ? "***hidden***" : "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç",
    });

    // –í–∞–ª–∏–¥–∞—Ü–∏—è: email, name, password –∏ zodiac –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã, birthday –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º
    if (!email || !name || !password || !zodiac) {
      console.log("‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: –Ω–µ –≤—Å–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã");
      return res.status(400).json({
        success: false,
        message: "All fields are required",
      });
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è email
    if (!isValidEmail(email)) {
      console.log("‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ email:", email);
      return res.status(400).json({
        success: false,
        message: "Wrong email format",
      });
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è
    if (!isValidPassword(password)) {
      console.log("‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–∞—Ä–æ–ª—è: —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π");
      return res.status(400).json({
        success: false,
        message: "Password must be at least 6 characters long",
      });
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–Ω—è —Ä–æ–∂–¥–µ–Ω–∏—è
    if (birthday && !isValidBirthday(birthday)) {
      console.log("‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è:", birthday);
      return res.status(400).json({
        success: false,
        message: "Wrong birthday format",
      });
    }

    // Validation of zodiac sign
    if (!isValidZodiac(zodiac)) {
      console.log("‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∑–Ω–∞–∫–∞ –∑–æ–¥–∏–∞–∫–∞:", zodiac);
      return res.status(400).json({
        success: false,
        message: "Wrong zodiac sign",
      });
    }

    console.log("‚úÖ All validations passed successfully");
    const client = await pool.connect();
    console.log("‚úÖ Database connection established");

    try {
      // Check if user with such email already exists
      console.log("üîç Checking if user with email exists:", email);
      const existingUser = await client.query(
        "SELECT id_user FROM users WHERE email = $1",
        [email]
      );

      if (existingUser.rows.length > 0) {
        console.log("‚ùå User already exists");
        return res.status(400).json({
          success: false,
          message: "User with this email already exists",
        });
      }

      console.log("‚úÖ User does not exist, continuing registration");

      // Hash the password
      console.log("üîê Hashing password...");
      const saltRounds = 10;
      const passwordHash = await bcrypt.hash(password, saltRounds);
      console.log("‚úÖ Password hashed");

      console.log("üíæ Executing INSERT query...");
      console.log("üìù Parameters:", [
        name,
        email,
        birthday || null,
        zodiac,
        "***hidden***",
        false,
      ]);

      // Creating user (using the correct table structure)
      // –î–ª—è –ø–æ–ª—è DATE –≤ PostgreSQL sending string –±–µ–∑ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤ Date
      const birthdayForDB = birthday ? birthday : null;

      console.log("Saving date to DB:", birthdayForDB);

      const result = await client.query(
        `
        INSERT INTO users (first_name, email, birthday, zodiac, password, subscription, created_at) 
        VALUES ($1, $2, $3, $4, $5, $6, NOW()) 
        RETURNING id_user, first_name, email, to_char(birthday, 'YYYY-MM-DD') AS birthday, zodiac, created_at
      `,
        [name, email, birthdayForDB, zodiac, passwordHash, false]
      );

      console.log("‚úÖ INSERT –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ");
      console.log("üìÑ –†–µ–∑—É–ª—å—Ç–∞—Ç INSERT:", result.rows[0]);

      const newUser = result.rows[0];
      logSuccess("The new user has been registered:", {
        id: newUser.id_user,
        email: newUser.email,
        name: newUser.first_name,
        zodiac: newUser.zodiac,
      });

      res.json({
        success: true,
        message: "Registration successful!",
        user: {
          id: newUser.id_user,
          email: newUser.email,
          name: newUser.first_name,
          birthday: newUser.birthday,
          zodiac: newUser.zodiac,
        },
      });
    } catch (dbError) {
      logError("Database error during registration:", dbError);

      // Check error type
      if (dbError.code === "23505") {
        // Unique constraint violation
        return res.status(400).json({
          success: false,
          message: "User with this email already exists",
        });
      }

      throw dbError; // Rethrow unknown errors
    } finally {
      client.release();
    }
  } catch (error) {
    logError("Registration error:", error);
    res.status(500).json({
      success: false,
      message: "Server error during registration",
      error: process.env.NODE_ENV === "development" ? error.message : undefined,
    });
  }
});
app.post("/api/login", async (req, res) => {
  try {
    const { email, password } = req.body;

    if (!email || !password) {
      return res.status(400).json({
        success: false,
        message: "Email –∏ password –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã",
      });
    }

    const client = await pool.connect();

    // Searching user by email
    // Converting birthday to string format YYYY-MM-DD to avoid timezone issues
    const userResult = await client.query(
      "SELECT id_user, email, first_name, to_char(birthday, 'YYYY-MM-DD') AS birthday, zodiac, password FROM users WHERE email = $1",
      [email]
    );

    client.release();

    if (userResult.rows.length === 0) {
      return res.status(401).json({
        success: false,
        message: "Wrong email or password",
      });
    }

    const user = userResult.rows[0];

    // Validating password
    const isPasswordValid = await bcrypt.compare(password, user.password);

    if (!isPasswordValid) {
      return res.status(401).json({
        success: false,
        message: "Incorrect email or password",
      });
    }

    console.log("User logged in:", user.email);
    console.log(
      "Birthday from DB (string):",
      user.birthday,
      typeof user.birthday
    );

    // Today's horoscope, if it exists in the DB
    let todayHoroscope = null;
    const today = new Date().toISOString().split("T")[0]; //  YYYY-MM-DD

    try {
      const horoscopeClient = await pool.connect();
      const horoscopeResult = await horoscopeClient.query(
        "SELECT response FROM horoscops WHERE id_user = $1 AND horoscop_date = $2",
        [user.id_user, today]
      );

      if (horoscopeResult.rows.length > 0) {
        try {
          const responseData = horoscopeResult.rows[0].response;
          console.log(`üîç –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î:`, typeof responseData);

          console.log(
            `üîç –ü–µ—Ä–≤—ã–µ 100 —Å–∏–º–≤–æ–ª–æ–≤:`,
            String(responseData).substring(0, 100)
          );

          // If it's already an object, use as is
          if (typeof responseData === "object" && responseData !== null) {
            todayHoroscope = responseData;
            console.log(`‚úÖ Horoscope loaded as object`);
          } else {
            // If it's a string, parse JSON
            todayHoroscope = JSON.parse(responseData);
            console.log(`‚úÖ Horoscope loaded via JSON.parse`);
          }

          console.log(
            `‚úÖ Found horoscope for today (${today}) for user ${user.email}`
          );
        } catch (parseError) {
          console.error(`‚ùå JSON horoscope parsing error:`, parseError.message);
          console.error(
            `‚ùå Response content:`,
            horoscopeResult.rows[0].response
          );
          todayHoroscope = null;
        }
      } else {
        console.log(
          `‚ÑπÔ∏è Horoscope for today (${today}) not found for user ${user.email}`
        );
      }
      horoscopeClient.release();
    } catch (horoscopeError) {
      console.error("‚ùå Horoscope fetching error:", horoscopeError.message);
    }

    res.json({
      success: true,
      message: "Login successful!",
      user: {
        id: user.id_user,
        email: user.email,
        name: user.first_name,
        birthday: user.birthday,
        zodiac: user.zodiac,
      },
      todayHoroscope: todayHoroscope,
    });
  } catch (error) {
    console.error("Error during authorization:", error);
    res.status(500).json({
      success: false,
      message: "Server error during authorization",
    });
  }
});

// Temporary endpoint for date debugging
app.get("/api/debug-dates", async (req, res) => {
  try {
    const client = await pool.connect();
    const result = await client.query(
      "SELECT email, to_char(birthday, 'YYYY-MM-DD') AS birthday FROM users WHERE birthday IS NOT NULL LIMIT 3"
    );

    const debugInfo = result.rows.map((row) => ({
      email: row.email,
      rawBirthday: row.birthday,
      birthdayType: typeof row.birthday,
      birthdayString: String(row.birthday),
      formattedBirthday: formatDateOnly(row.birthday),
    }));

    client.release();

    res.json({
      success: true,
      data: debugInfo,
    });
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –æ—Ç–ª–∞–¥–∫–∏ –¥–∞—Ç:", error);
    res.status(500).json({
      success: false,
      error: error.message,
    });
  }
});

// Endpoint –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
app.post("/api/update-profile", async (req, res) => {
  try {
    const { email, name, birthday, zodiac, password } = req.body;

    if (!email || !name) {
      return res.status(400).json({
        success: false,
        message: "Email and name are required",
      });
    }

    const client = await pool.connect();

    // Checking if user exists
    const userResult = await client.query(
      "SELECT id_user FROM users WHERE email = $1",
      [email]
    );

    if (userResult.rows.length === 0) {
      client.release();
      return res.status(404).json({
        success: false,
        message: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω",
      });
    }

    // Preparing data for update
    let updateQuery = "UPDATE users SET first_name = $1";
    let updateParams = [name];
    let paramIndex = 2;

    // birthday and zodiac
    if (birthday) {
      updateQuery += `, birthday = $${paramIndex}`;
      updateParams.push(birthday);
      paramIndex++;
      // zodiac –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –∏ –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ req.body
      if (zodiac) {
        updateQuery += `, zodiac = $${paramIndex}`;
        updateParams.push(zodiac);
        paramIndex++;
      }
    } else {
      // birthday –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, zodiac –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é
      updateQuery += `, birthday = NULL`;
      if (zodiac) {
        updateQuery += `, zodiac = $${paramIndex}`;
        updateParams.push(zodiac);
        paramIndex++;
      }
    }

    // Adding password if specified
    if (password) {
      const hashedPassword = await bcrypt.hash(password, 10);
      updateQuery += `, password = $${paramIndex}`;
      updateParams.push(hashedPassword);
      paramIndex++;
    }

    updateQuery += ` WHERE email = $${paramIndex}`;
    updateParams.push(email);

    // Updating
    await client.query(updateQuery, updateParams);

    client.release();

    console.log("Profile updated:", email);

    res.json({
      success: true,
      message: "The profile has been successfully updated!",
    });
  } catch (error) {
    console.error("Error updating profile:", error);
    res.status(500).json({
      success: false,
      message: "Server error during profile update",
    });
  }
});

// –ú–∞—Ä—à—Ä—É—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≥–æ—Ä–æ—Å–∫–æ–ø–æ–≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
app.get("/api/user-horoscopes/:userId", async (req, res) => {
  try {
    const userId = req.params.userId;

    const client = await pool.connect();
    const result = await client.query(
      `
      SELECT h.*, u.first_name, u.zodiac 
      FROM horoscops h 
      JOIN users u ON h.id_user = u.id_user 
      WHERE h.id_user = $1 
      ORDER BY h.horoscop_date DESC 
      LIMIT 20
    `,
      [userId]
    );

    client.release();

    res.json({
      success: true,
      horoscopes: result.rows.map((row) => ({
        id: row.id,
        date: row.horoscop_date,
        content: row.response,
        name: row.first_name,
        zodiac: row.zodiac,
      })),
    });
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≥–æ—Ä–æ—Å–∫–æ–ø–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
    res.status(500).json({
      success: false,
      message: "‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≥–æ—Ä–æ—Å–∫–æ–ø–æ–≤",
      error: error.message,
    });
  }
});

//const fetch = require("node-fetch"); // Check reCAPTCHA
const fetch = (...args) =>
  import("node-fetch").then(({ default: fetch }) => fetch(...args));

async function verifyCaptcha(token) {
  const secret = process.env.RECAPTCHA_SECRET_KEY;
  const response = await fetch(
    `https://www.google.com/recaptcha/api/siteverify?secret=${secret}&response=${token}`,
    { method: "POST" }
  );
  const data = await response.json();
  return data.success;
}

// –ú–∞—Ä—à—Ä—É—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≥–æ—Ä–æ—Å–∫–æ–ø–æ–≤
app.post("/api/horoscope", async (req, res) => {
  try {
    const { name, zodiac, date, birthday, isLoggedIn, userId, captcha } =
      req.body || {};

    // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É AI –∏ mock –¥–∞–Ω–Ω—ã–º–∏
    // 0 = –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å OpenAI API, 1 = –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    const USE_MOCK_DATA = 0; // –ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ 1 –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

    console.log(
      `–ó–∞–ø—Ä–æ—Å –≥–æ—Ä–æ—Å–∫–æ–ø–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ID ${userId}, –¥–∞—Ç–∞ ${date}, –∑–∞–ª–æ–≥–∏–Ω–µ–Ω: ${isLoggedIn}`
    );

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ reCAPTCHA –¥–ª—è –Ω–µ–∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    if (!isLoggedIn) {
      const captchaValid = await verifyCaptcha(captcha);
      if (!captchaValid) {
        return res.status(400).json({ error: "–ö–∞–ø—á–∞ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞" });
      }
    }

    // For logged-in users, first check the database
    if (isLoggedIn && userId) {
      console.log(
        `üîç Checking database for horoscope for user ${userId} on date ${date}`
      );

      const client = await pool.connect();
      try {
        const existingHoroscope = await client.query(
          "SELECT response FROM horoscops WHERE id_user = $1 AND horoscop_date = $2",
          [userId, date]
        );

        if (existingHoroscope.rows.length > 0) {
          console.log(`‚úÖ –ù–∞–π–¥–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –≥–æ—Ä–æ—Å–∫–æ–ø –≤ –ë–î –¥–ª—è –¥–∞—Ç—ã ${date}`);
          try {
            const responseData = existingHoroscope.rows[0].response;
            let savedResponse;

            // If it's already an object, use as is
            if (typeof responseData === "object" && responseData !== null) {
              savedResponse = responseData;
            } else {
              // If it's a string, parse JSON
              savedResponse = JSON.parse(responseData);
            }

            // Adding a slight delay to simulate search
            await new Promise((resolve) => setTimeout(resolve, 1500));
            console.log(`‚è∞ Delay of 1.5 seconds to simulate search completed`);

            return res.json(savedResponse);
          } catch (parseError) {
            console.error(
              `‚ùå Error parsing existing horoscope:`,
              parseError.message
            );
            console.log(`‚ÑπÔ∏è Generating new horoscope due to parsing error`);
          }
        } else {
          console.log(
            `‚ÑπÔ∏è Horoscope for date ${date} not found in DB, generating new one`
          );
        }
      } catch (dbError) {
        console.error("‚ùå Error checking DB:", dbError.message);
      } finally {
        client.release();
      }
    }

    const infoSections = [
      "General",
      "Work",
      "Health",
      "Finance",
      "Travel",
      "Relationships",
      "Advice",
    ];

    let result;

    if (USE_MOCK_DATA === 1) {
      // Use mock data
      console.log("Using mock data");
      result = {
        horoscope: {
          General: `Hello ${name}! As a ${zodiac}, today brings exciting opportunities for personal growth and self-discovery. The stars align favorably for you, encouraging bold decisions and positive changes in your life.`,
          Work: "Your professional life shows promising developments today. New projects may come your way, and your creative abilities will be particularly sharp. Collaboration with colleagues will lead to innovative solutions.",
          Health:
            "Pay attention to your physical well-being today. A balanced diet and regular exercise will boost your energy levels significantly. Consider trying a new wellness routine or meditation practice.",
          Finance:
            "Financial opportunities are on the horizon, but careful planning is essential. Avoid impulsive purchases and focus on long-term investment strategies. A financial advisor's guidance could prove valuable.",
          Travel:
            "Travel plans may face minor delays, but these setbacks will lead to unexpected discoveries. Local exploration might bring more joy than distant journeys. Keep your travel documents updated.",
          Relationships:
            "Your charm and charisma are at their peak today. Single individuals may encounter someone special, while those in relationships should focus on deeper communication. Family bonds strengthen through shared activities.",
          Advice:
            "Trust your intuition and embrace change with confidence. The universe supports your efforts toward personal transformation. Remember that patience and persistence will lead to remarkable achievements.",
        },
      };
    } else {
      // Use OpenAI API
      const prompt = `–¢—ã –∞—Å—Ç—Ä–æ–ª–æ–≥. –û—Ç–≤–µ—á–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º JSON —Å —Ä–∞–∑–¥–µ–ª–∞–º–∏: ${infoSections.join(
        ", "
      )}. 
          –û—Ç–≤–µ—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º. –ö–∞–∂–¥—ã–π —Ä–∞–∑–¥–µ–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ–¥–∏–Ω –∞–±–∑–∞—Ü —Å –Ω–µ –º–µ–Ω–µ–µ 2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏. 
          –í–æ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –ò–º—è: ${name}, –ó–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞: ${zodiac}, –î–∞—Ç–∞ –≥–æ—Ä–æ—Å–∫–æ–ø–∞: ${date}. 
          –°–¥–µ–ª–∞–π –≥–æ—Ä–æ—Å–∫–æ–ø –Ω–∞ —ç—Ç—É –¥–∞—Ç—É, –∏—Å–ø–æ–ª—å–∑—É—è —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ. –í —Ä–∞–∑–¥–µ–ª–µ "General" –æ–±—Ä–∞—Ç–∏—Å—å –ø–æ –∏–º–µ–Ω–∏.
          –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ç—Ä–æ–≥–æ —Ç–∞–∫–æ–π:
          {
            "horoscope": {
              "General": "...",
              "Work": "...",
              "Health": "...",
              "Finance": "...",
              "Travel": "...",
              "Relationships": "...",
              "Advice": "..."
            }
          }
      
      –û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ JSON, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏ —Ç–µ–∫—Å—Ç–∞.`;

      try {
        console.log("Making request to OpenAI API");
        // Call OpenAI API for horoscope generation
        const completion = await openai.chat.completions.create({
          model: "gpt-3.5-turbo",
          messages: [{ role: "user", content: prompt }],
          temperature: 0.7,
        });

        result = JSON.parse(completion.choices[0].message.content);
        console.log("Received response from OpenAI API");
      } catch (openaiError) {
        console.error("OpenAI Error:", openaiError);

        // Fallback on mock data if OpenAI is unavailable
        console.log("OpenAI is unavailable, using mock data");
        result = {
          horoscope: {
            General: `Hello ${name}! As a ${zodiac}, today brings exciting opportunities for personal growth and self-discovery. The stars align favorably for you, encouraging bold decisions and positive changes in your life.`,
            Work: "Your professional life shows promising developments today. New projects may come your way, and your creative abilities will be particularly sharp. Collaboration with colleagues will lead to innovative solutions.",
            Health:
              "Pay attention to your physical well-being today. A balanced diet and regular exercise will boost your energy levels significantly. Consider trying a new wellness routine or meditation practice.",
            Finance:
              "Financial opportunities are on the horizon, but careful planning is essential. Avoid impulsive purchases and focus on long-term investment strategies. A financial advisor's guidance could prove valuable.",
            Travel:
              "Travel plans may face minor delays, but these setbacks will lead to unexpected discoveries. Local exploration might bring more joy than distant journeys. Keep your travel documents updated.",
            Relationships:
              "Your charm and charisma are at their peak today. Single individuals may encounter someone special, while those in relationships should focus on deeper communication. Family bonds strengthen through shared activities.",
            Advice:
              "Trust your intuition and embrace change with confidence. The universe supports your efforts toward personal transformation. Remember that patience and persistence will lead to remarkable achievements.",
          },
        };
      }
    }

    // Saving to DB for logged-in users
    if (isLoggedIn && userId) {
      console.log(
        `Saving horoscope to DB for user ID: ${userId}, date: ${date}`
      );

      const client = await pool.connect();
      try {
        // Check if horoscope already exists for this user on this date
        const existingHoroscope = await client.query(
          "SELECT id FROM horoscops WHERE id_user = $1 AND horoscop_date = $2",
          [userId, date]
        );

        if (existingHoroscope.rows.length === 0) {
          // Save new horoscope
          const insertResult = await client.query(
            "INSERT INTO horoscops (id_user, horoscop_date, response) VALUES ($1, $2, $3) RETURNING id",
            [userId, date, JSON.stringify(result)]
          );

          console.log(
            `‚úÖ Horoscope saved to DB with ID: ${insertResult.rows[0].id}`
          );
        } else {
          console.log(
            "‚ÑπÔ∏è Horoscope for this date already exists, skipping save"
          );
        }
      } catch (dbError) {
        console.error("‚ùå Error saving to DB:", dbError.message);
        console.error("‚ùå Error details:", dbError);
      } finally {
        client.release();
      }
    } else {
      console.log(
        "‚ÑπÔ∏è User is not logged in or userId is missing, skipping DB save"
      );
      console.log("isLoggedIn:", isLoggedIn, "userId:", userId);
    }

    res.json(result);
  } catch (error) {
    console.error("‚ùå CRITICAL ERROR in /api/horoscope:", error);
    console.error("‚ùå Stack trace:", error.stack);
    console.error("‚ùå Error message:", error.message);
    res
      .status(500)
      .json({ error: "Error fetching horoscope", details: error.message });
  }
});

// Route for fetching saved horoscopes
app.get("/api/horoscopes", async (req, res) => {
  try {
    const result = await pool.query(`
      SELECT h.*, u.first_name, u.birthday, u.zodiac 
      FROM horoscops h 
      JOIN users u ON h.id_user = u.id_user 
      ORDER BY h.horoscop_date DESC 
      LIMIT 10
    `);

    res.json({
      success: true,
      horoscopes: result.rows,
    });
  } catch (error) {
    console.error("Error fetching horoscopes:", error);
    res.status(500).json({
      success: false,
      message: "‚ùå Error fetching horoscopes",
      error: error.message,
    });
  }
});

const PORT = process.env.PORT || 3000;

app.listen(PORT, "0.0.0.0", () => {
  console.log(`üöÄ Server is running on port ${PORT}`);
  console.log(`Application is available at: http://localhost:${PORT}`);
});
